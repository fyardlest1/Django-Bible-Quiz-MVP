{% extends 'quiz_ui/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    
    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-gray-600">Loading today's questions...</p>
    </div>

    <!-- Quiz Container -->
    <div id="quiz-container" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 h-2">
            <div id="progress-bar" class="bg-green-500 h-2 transition-all duration-300" style="width: 0%"></div>
        </div>

        <div class="p-6">
            <!-- Question Header -->
            <div class="flex justify-between items-center mb-4">
                <span id="category-badge" class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">Category</span>
                <span class="text-gray-500 text-sm">Question <span id="current-index">1</span>/<span id="total-count">?</span></span>
            </div>

            <!-- Question Text -->
            <h2 id="question-text" class="text-xl font-bold text-gray-800 mb-6 min-h-[80px]">...</h2>

            <!-- Options -->
            <div id="options-container" class="space-y-3">
                <!-- Buttons injected by JS -->
            </div>

            <!-- Explanation (Hidden initially) -->
            <div id="explanation-box" class="hidden mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                <p class="font-bold text-yellow-800"><i class="fa-solid fa-lightbulb"></i> Insight:</p>
                <p id="explanation-text" class="text-yellow-700 text-sm mt-1">...</p>
                <button onclick="nextQuestion()" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Next Question <i class="fa-solid fa-arrow-right ml-1"></i></button>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="hidden text-center bg-white p-8 rounded-xl shadow-lg">
        <i class="fa-solid fa-award text-6xl text-yellow-400 mb-4"></i>
        <h2 class="text-3xl font-bold text-gray-800">Quiz Complete!</h2>
        <p class="text-gray-600 mt-2">You scored <span id="final-score" class="font-bold text-indigo-600 text-xl">0</span> out of <span id="final-total">0</span></p>
        
        <div class="mt-8 flex gap-4 justify-center">
            <a href="{% url 'quiz_ui:home' %}" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300">Home</a>
            <a href="{% url 'quiz_ui:leaderboard' %}" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Leaderboard</a>
        </div>
    </div>

</div>

<script>
    let questions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let score = 0; // Local optimistic score tracking

    async function initQuiz() {
        try {
            const response = await fetch('/api/daily-quiz/');
            questions = await response.json();
            
            if (questions.error) throw new Error(questions.error);
            
            document.getElementById('total-count').innerText = questions.length;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            
            renderQuestion();
        } catch (e) {
            document.getElementById('loading').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
        }
    }

    function renderQuestion() {
        const q = questions[currentIdx];
        document.getElementById('current-index').innerText = currentIdx + 1;
        document.getElementById('question-text').innerText = q.question_text;
        document.getElementById('category-badge').innerText = q.category_display;
        
        // Update Progress
        const percent = ((currentIdx) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${percent}%`;

        // Reset UI
        document.getElementById('explanation-box').classList.add('hidden');
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        container.classList.remove('pointer-events-none', 'opacity-50');

        q.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left p-4 bg-gray-50 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition";
            btn.innerText = choice;
            btn.onclick = () => handleAnswer(q.id, choice, btn);
            container.appendChild(btn);
        });
    }

    function handleAnswer(qId, answer, btnElement) {
        // Disable further clicks
        document.getElementById('options-container').classList.add('pointer-events-none');
        
        // Highlight selection
        btnElement.classList.remove('bg-gray-50');
        btnElement.classList.add('bg-indigo-100', 'border-indigo-500', 'ring-2', 'ring-indigo-200');

        userAnswers.push({
            question_id: qId,
            selected_answer: answer
        });

        // Simulate "Next" delay or show explanation if you had them client-side
        // For MVP, we just move to next step after a tiny delay
        setTimeout(() => {
             // In a real app with "Instant Explanation", we would submit individually or reveal here.
             // Since our API grades in bulk or returns explanation on submission, 
             // we will just move next for simplicity in this MVP flow, 
             // OR we could do a single-question check if we refactored the API.
             // Let's stick to bulk submission at the end for the "Daily Quiz" feel.
             nextQuestion();
        }, 500);
    }

    async function nextQuestion() {
        currentIdx++;
        if (currentIdx < questions.length) {
            renderQuestion();
        } else {
            await submitQuiz();
        }
    }

    async function submitQuiz() {
        document.getElementById('quiz-container').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerHTML = "<p>Submitting results...</p>";

        const deviceId = getDeviceId();
        
        try {
            const response = await fetch(`/api/submit-answers/?device_id=${deviceId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Django CSRF
                },
                body: JSON.stringify(userAnswers)
            });
            
            const result = await response.json();
            
            // Show Results
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('final-score').innerText = result.score;
            document.getElementById('final-total').innerText = result.total_questions;

        } catch (e) {
            alert("Error submitting quiz");
        }
    }

    // Helper for Django CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    initQuiz();
</script>
{% endblock %}