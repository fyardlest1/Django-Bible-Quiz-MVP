{% extends 'quiz_ui/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    
    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-gray-600">Loading today's questions...</p>
    </div>

    <!-- Quiz Container -->
    <div id="quiz-container" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 h-2">
            <div id="progress-bar" class="bg-green-500 h-2 transition-all duration-300" style="width: 0%"></div>
        </div>

        <div class="p-6">
            <!-- Question Header -->
            <div class="flex justify-between items-center mb-4">
                <span id="category-badge" class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">Category</span>
                <span class="text-gray-500 text-sm">Question <span id="current-index">1</span>/<span id="total-count">?</span></span>
            </div>

            <!-- Question Text -->
            <h2 id="question-text" class="text-xl font-bold text-gray-800 mb-6 min-h-[80px]">...</h2>

            <!-- Options -->
            <div id="options-container" class="space-y-3">
                <!-- Buttons injected by JS -->
            </div>

            <!-- Explanation (Hidden initially) -->
            <div id="explanation-box" class="hidden mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                <p class="font-bold text-yellow-800"><i class="fa-solid fa-lightbulb"></i> Insight:</p>
                <p id="explanation-text" class="text-yellow-700 text-sm mt-1">...</p>
                <button onclick="nextQuestion()" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Next Question <i class="fa-solid fa-arrow-right ml-1"></i></button>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="hidden text-center bg-white p-8 rounded-xl shadow-lg">
        <i class="fa-solid fa-award text-6xl text-yellow-400 mb-4"></i>
        <h2 class="text-3xl font-bold text-gray-800">Quiz Complete!</h2>
        <p class="text-gray-600 mt-2">You scored <span id="final-score" class="font-bold text-indigo-600 text-xl">0</span> out of <span id="final-total">0</span></p>
        
        <!-- Detailed Results Table -->
        <div class="mt-8 mb-8 overflow-x-auto text-left">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-200">
                        <th class="px-4 py-2 text-sm font-semibold text-gray-600">Scripture / Question</th>
                        <th class="px-4 py-2 text-sm font-semibold text-gray-600">Your Answer</th>
                        <th class="px-4 py-2 text-sm font-semibold text-gray-600">Read Bible Ref.</th>
                    </tr>
                </thead>
                <tbody id="results-table-body" class="text-sm divide-y divide-gray-100">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>

        <div class="flex gap-4 justify-center">
            <a href="{% url 'quiz_ui:home' %}" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300">Home</a>
            <a href="{% url 'quiz_ui:leaderboard' %}" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Leaderboard</a>
        </div>
    </div>

</div>

<!-- LEAD CAPTURE MODAL (Funnel Step 3) -->
<div id="email-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 relative transform transition-all scale-100">
        <!-- Close Button -->
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 mb-4">
                <i class="fa-solid fa-fire text-3xl text-orange-600"></i>
            </div>
            
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Great score!</h3>
            
            <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                Enter your email to save your <strong>Streak</strong> permanently and get a daily reminder so you never miss a day.
            </p>
            
            <div class="space-y-3">
                <input type="email" id="user-email" placeholder="name@example.com" 
                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
                
                <button onclick="saveEmail()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition shadow-md">
                    Save My Streak
                </button>
            </div>
            
            <button onclick="closeModal()" class="mt-4 text-xs text-gray-400 hover:text-gray-600 hover:underline">
                No thanks, I'll play as guest
            </button>
        </div>
    </div>
</div>

<script>
    let questions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let score = 0; // Local optimistic score tracking

    async function initQuiz() {
        try {
            // Check for force refresh
            const urlParams = new URLSearchParams(window.location.search);
            const refresh = urlParams.get('refresh') === 'true' ? '?refresh=true' : '';
            
            const response = await fetch(`/api/daily-quiz/${refresh}`);
            questions = await response.json();
            
            if (questions.error) throw new Error(questions.error);
            
            document.getElementById('total-count').innerText = questions.length;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            
            renderQuestion();
        } catch (e) {
            document.getElementById('loading').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
        }
    }

    function renderQuestion() {
        const q = questions[currentIdx];
        document.getElementById('current-index').innerText = currentIdx + 1;
        document.getElementById('question-text').innerText = q.question_text;
        document.getElementById('category-badge').innerText = q.category_display;
        
        // Update Progress
        const percent = ((currentIdx) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${percent}%`;

        // Reset UI
        document.getElementById('explanation-box').classList.add('hidden');
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        container.classList.remove('pointer-events-none', 'opacity-50');

        q.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left p-4 bg-gray-50 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition";
            btn.innerText = choice;
            btn.onclick = () => handleAnswer(q.id, choice, btn);
            container.appendChild(btn);
        });
    }

    function handleAnswer(qId, answer, btnElement) {
        // Disable further clicks
        document.getElementById('options-container').classList.add('pointer-events-none');
        
        // Highlight selection
        btnElement.classList.remove('bg-gray-50');
        btnElement.classList.add('bg-indigo-100', 'border-indigo-500', 'ring-2', 'ring-indigo-200');

        userAnswers.push({
            question_id: qId,
            selected_answer: answer
        });

        setTimeout(() => {
            nextQuestion();
        }, 500);
    }

    async function nextQuestion() {
        currentIdx++;
        if (currentIdx < questions.length) {
            renderQuestion();
        } else {
            await submitQuiz();
        }
    }

    async function submitQuiz() {
        document.getElementById('quiz-container').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerHTML = "<p>Submitting results...</p>";

        const deviceId = getDeviceId();
        
        try {
            const response = await fetch(`/api/submit-answers/?device_id=${deviceId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Django CSRF
                },
                body: JSON.stringify(userAnswers)
            });
            
            const result = await response.json();
            
            // Populate Results Table
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '';

            result.results.forEach(res => {
                const originalQ = questions.find(q => q.id === res.question_id);
                const questionText = originalQ ? originalQ.question_text : 'Unknown Question';
                const rowClass = res.is_correct ? 'bg-green-50' : 'bg-red-50';
                const icon = res.is_correct 
                    ? '<i class="fa-solid fa-check text-green-600 ml-2"></i>' 
                    : '<i class="fa-solid fa-xmark text-red-600 ml-2"></i>';
                const answerColor = res.is_correct ? 'text-green-700' : 'text-red-700';

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100";
                
                tr.innerHTML = `
                    <td class="px-4 py-3 text-gray-700 font-medium">
                        ${questionText.substring(0, 60)}${questionText.length > 60 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 ${answerColor} font-bold whitespace-nowrap">
                        ${res.selected_answer} ${icon}
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-xs italic">
                        ${res.correct_answer}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Show Results Container
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('final-score').innerText = result.score;
            document.getElementById('final-total').innerText = result.total_questions;
            
            // TRIGGER LEAD CAPTURE MODAL
            // We wait 1.5 seconds to let the user see their score first
            setTimeout(() => {
                const hasSavedEmail = localStorage.getItem('email_saved');
                if (!hasSavedEmail) {
                    document.getElementById('email-modal').classList.remove('hidden');
                }
            }, 1500);

        } catch (e) {
            console.error(e);
            alert("Error submitting quiz: " + e.message);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
        }
    }

    // Modal Logic
    function closeModal() {
        document.getElementById('email-modal').classList.add('hidden');
    }

    function saveEmail() {
        const email = document.getElementById('user-email').value;
        if(email && email.includes('@')) {
            // For MVP, we simply save to localStorage to suppress the modal next time.
            // In V2, you would POST this to an /api/subscribe/ endpoint.
            localStorage.setItem('email_saved', 'true');
            alert(`Thanks! Streak saved to ${email}.`);
            closeModal();
        } else {
            alert("Please enter a valid email address.");
        }
    }

    // Helper for Django CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    initQuiz();
</script>
{% endblock %}